<!DOCTYPE html>
    <head>
        <title>ReflowOven</title>
    </head>
    <body style="text-align: center;"> 

        <table>
            <thead>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div style="text-align: center;">
                            <button onclick="send_start()" style="background-color: green;">start</button>
                            <button onclick="send_stop()" style="background-color: red;">STOP</button>
                        </div>
                    </td>
                    <td>
                        <div style="text-align: center;">
                            <h3>BEP: Reflow Oven</h3>
                            <div id="errorid" style="display: none; background-color: red;">
                                <h1>ERROR DETECTED</h1>
                            </div>
                        </div>
                        
                    </td>
                    <td>
                        <div style="text-align: center;">
                            <button onclick="send_refresh()">&#8634;</button>
                        </div>
                    </td>
                </tr>

                <tr>
                    <td>
                        <div style="text-align: center;">
                            3
                        </div>
                    </td>
                    <td>
                        <div style="width: 60vw;">
                            <canvas id="chartcanvas"></canvas>
                        </div>
                    </td>
                    <td>
                        <div style="text-align: center;">
                            5
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="text-align: center;">
                            6
                        </div>
                    </td>
                    <td>
                        <div style="text-align: center;">
                            <p id="runningtext"></p>
                            <p id="heatingtext"></p>
                            <p id="heatingdutytext"></p>
                            <p id="targettemptext"></p>
                            <p id="coolingtext"></p>
                            <p id="coolingpostext"></p>
                            <p id="memtext"></p>
                        </div>
                    </td>
                    <td>
                        <div style="text-align: center;">
                            8
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

          
        <script src="chart.js"></script>
        
        <script>
            const ctx = document.getElementById('chartcanvas');
        
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0'],
                    datasets: [{
                    label: 'Temperatuur (C)',
                    data: [0],
                    borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                    y: {
                        beginAtZero: true
                    }
                    }
                }
            });
        </script>
        


        <script type="text/javascript">

            const socket = new WebSocket("ws://"+window.location.host+":80/websocket");
            var globalstate = 0

            // Listen for messages
            socket.addEventListener("message", (event) => {
                globalstate = JSON.parse(event.data);
                // console.log(globalstate);
                
                document.getElementById("runningtext").innerHTML = 'running: ' + globalstate['running'];
                document.getElementById("heatingtext").innerHTML = 'heating: ' + globalstate['heating'];
                globalstate['heating_percentage'] = (parseFloat(globalstate['heating_duty']) / 10.23).toFixed(0);
                document.getElementById("heatingdutytext").innerHTML = 'heating duty cycle: ' + globalstate['heating_percentage'] + "%";
                document.getElementById("coolingtext").innerHTML = 'cooling: ' + globalstate['cooling'];
                document.getElementById("coolingpostext").innerHTML = 'cooling position: ' + globalstate['cooling_pos'];
                document.getElementById("memtext").innerHTML = 'memory free: ' + globalstate['memfree'] + "kb";

                if (globalstate['error_detected'] == true){
                    document.getElementById("errorid").style.display = 'block';
                }

                chart.destroy()

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...Array(globalstate['temp1'].length).keys()],
                        datasets: [{
                        label: 'Temperatuur1 (C)',
                        data: globalstate['temp1'],
                        borderWidth: 1,
                        backgroundColor: 'rgba(0, 0, 255, 0.5)'
                        },
                        {
                        label: 'Temperatuur2 (C)',
                        data: globalstate['temp2'],
                        borderWidth: 1,
                        backgroundColor: 'rgba(0, 255, 0, 0.5)'
                        },
                        {
                        label: 'Target Temperatuur (C)',
                        data: globalstate['target_temp'],
                        borderWidth: 1,
                        backgroundColor: 'rgba(255, 0, 0, 0.5)'
                        }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    align: 'center',
                                    text: 'Degrees (C)',
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    align: 'center',
                                    text: 'Time (seconds)',
                                }
                            }
                        },
                        animation: false,
                        transitions: false
                    }
                });

            });

            var intervalId = window.setInterval(send_refresh, 2500);

            function send_refresh(){
                socket.send(JSON.stringify({
                    'refresh': 'refresh'
                }));
            }

            function send_start(){
                socket.send(JSON.stringify({
                    'start_run': 'start_run'
                }));
            }

            function send_stop(){
                socket.send(JSON.stringify({
                    'STOP': 'STOP'
                }));
            }

        </script>

    </body>
</html>